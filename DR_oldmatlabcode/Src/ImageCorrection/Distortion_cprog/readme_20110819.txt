***Revised version by Adrianna L. - 08/19/2011***

Algebraic Lens Distortion Model Estimation

Authors : Luis Alvarez, Luis Gomez, Rafael Sendra


INFORMATION ABOUT PROGRAM COMPILATION AND EXECUTION 

Step 1 : Download from IPOL paper page the file "lens distortion estimation.zip". This can be downloaded in zip format from the following
website: http://www.ipol.im/pub/algo/ags_algebraic_lens_distortion_estimation/.
The content of this zip archive is :

	a) lens_distortion.h, lens_distortion.c  : lens distortion model estimation library.
	b) ami_pol.h, ami_pol.c : polynomial real root estimation library.
	c) ami_tif.h, ami_tif.c : basic library to read/write usigned char uncompressed TIF image format.
	d) lens_distortion_estimation.c : main program with lens distortion estimation function calls.
	e) readme_20110819.txt : this file.
	f) calibration_pattern.tif : sample input image to test the program.
           **Note: Current grey level image of track is saved under test4.tif
	g) calibration_pattern_line_primitives.dat : sample line primitives to test the program. 
          **Note: The calibration_pattern_line_primitives.dat file must be created by the user, using the conventions
            described in (3) below under "Function parameter explanation." The coordinates of the points are obtained
            from the line drawn using the online demonstration (see above link). 
            Current file is calibration_pattern_line_primitives3.dat 

Step 2 : Extract into a saved directory.
Step 3: To compile, once the zip archive files are saved in the above directory, execute the "make" command in the terminal (for Linux): 

>make 

Step 3 : To execute the program on an input .tif image (note: must be grey level format to output coordinate file), enter in terminal:

>./lens_distortion_estimation (name_of_image).tif output.tif calibration_pattern_line_primitives(version).dat output_results.dat output_coordinates.dat

*Note: The () are not actually entered, but represent portions of text that are user-specific. A total of 6 arguments must be entered. 


Function parameter explanation : 

(1) calibration_pattern.tif is the input image that have to be in uncompressed TIF unsigned char (RGB or single channel) format.

(2) output.tif is the output lens distortion corrected image that is provided in TIF format

(3) calibration_pattern_line_primitives.dat is the input collection of points which belong to distorted lines presented in the image. 
This file is an ASCII file organized in the following way : First, in the file, we write the number of lines, next, for each line we 
write the number of points and the point coordinates. 

(4) output_results.dat is the output file where the coefficients of the estimated distortion models are stored. 

(5) output_coordinates.dat is the output file containing the corrected coordinates for the width*height (in pixels) # of points 
    that comprise the image. Column 1 = x-values & column 2 = y-values. Re-running the program overwrites this file.



----------------------------------------------------------------------------------------------------------------

Understanding the output_results.dat file:

This output file contains the complete solution for all the cases considered in the publication "An Algebraic Approach to Lens Distortion by Line Rectification", L. Alvarez, L. Gomez, R. Sendra, published in JMIV, July 2009.  From all the solutions (all valid), the one selected in the IPOL online demo as "solution" (best solution) is the solution obtained by first applying the algebraic method from the trivial solution and then improving it by means of the simple gradient method. Only even distortion coefficients are used (k2, k4).

The whole set of solutions is presented as follows (see aclaration below):

----------------------------------------------------------------------------------------------------------------
/* FIRST WE COMPUTE THE TRIVIAL SOLUTION FOR THE POLYNOMIAL GRADE Na=4 (note that this case includes the Na=2) */
 
Na=4; x0=(1,0,0,0,0)

----------------------------------------------------------------------------------------------------------------
SOLUTION 1: /* ALGEBRAIC METHOD FROM TRIVIAL SOLUTION. NO ZOOM APPLIED 


Na (degree of  lens distortion model polynom) = 	2
1 parameter, 1 iteration, variables updated: 		k[2]


Na (degree of  lens distortion model polynom)= 		4
1 parameter, 2 iterations, variables updated: 		k[2], k[4]


Na (degree of  lens distortion model polynom) = 	4
2 parameters, 1 iteration, variables updated: 		k[2], k[4]


---------------------------------------------------------------------------------------------------------------- 
SOLUTION 2: /* ALGEBRAIC METHOD FROM TRIVIAL SOLUTION. ZOOM APPLIED 


Na (degree of  lens distortion model polynom) = 	2
1 parameter, 1 iteration, variables updated: 		k[2]


Na (degree of  lens distortion model polynom)= 		4
1 parameter, 2 iterations, variables updated: 		k[2], k[4]


Na (degree of  lens distortion model polynom) = 	4
2 parameters, 1 iteration, variables updated: 		k[2], k[4]

---------------------------------------------------------------------------------------------------------------- 
SOLUTION 3: GRADIENT METHOD FROM TRIVIAL SOLUTION. NO ZOOM APPLIED 
	
Na (degree of  lens distortion model polynom) = 	2
MODIFIED VARIABLES THROUGH OPTIMIZATION:		k[2]


Na (degree of  lens distortion model polynom) = 	4
MODIFIED VARIABLES THROUGH OPTIMIZATION:		k[2], k[4]

---------------------------------------------------------------------------------------------------------------- 
SOLUTION 4: GRADIENT METHOD FROM TRIVIAL SOLUTION. ZOOM APPLIED 

Na (degree of  lens distortion model polynom) = 	2
MODIFIED VARIABLES THROUGH OPTIMIZATION:		k[2]


Na (degree of  lens distortion model polynom) = 	4
MODIFIED VARIABLES THROUGH OPTIMIZATION:		k[2], k[4]

---------------------------------------------------------------------------------------------------------------- 

SOLUTION 5: ALGEBRAIC METHOD (FROM TRIVIAL SOLUTION) + GRADIENT METHOD. NO ZOOM APPLIED 

Na (degree of  lens distortion model polynom) = 	2
1 parameter, 1 iteration, variables updated: 		k[2]
MODIFIED VARIABLES THROUGH GRADIENT OPTIMIZATION: 	k[2]


Na (degree of  lens distortion model polynom) = 	4
1 parameter, 2 iterations, variables updated: 		k[2], k[4]
MODIFIED VARIABLES THROUGH GRADIENT OPTIMIZATION: 	k[2], k[4]	


Na (degree of  lens distortion model polynom) = 	4
2 parameters, 1 iteration, variables updated: 		k[2], k[4]
MODIFIED VARIABLES THROUGH GRADIENT OPTIMIZATION: 	k[2], k[4]

---------------------------------------------------------------------------------------------------------------- 

SOLUTION 6: ALGEBRAIC METHOD (FROM TRIVIAL SOLUTION) + GRADIENT METHOD. ZOOM APPLIED 

Na (degree of  lens distortion model polynom) = 	2
1 parameter, 1 iteration, variables updated: 		k[2]
MODIFIED VARIABLES THROUGH GRADIENT OPTIMIZATION: 	k[2]


Na (degree of  lens distortion model polynom) = 	4
1 parameter, 2 iterations, variables updated:		k[2], k[4]
MODIFIED VARIABLES THROUGH GRADIENT OPTIMIZATION: 	k[2], k[4]	


Na (degree of  lens distortion model polynom) = 	4
2 parameters, 1 iteration, variables updated: 		k[2], k[4]
MODIFIED VARIABLES THROUGH GRADIENT OPTIMIZATION: 	k[2], k[4]


---------------------------------------------------------------------------------------------------------------- 

REMARK 1�:

Na (degree of  lens distortion model polynom) = 	2
1 parameter, 1 iteration, variables updated: 		k[2]

	This means that 1 iteration of the algebraic method is applied and only one variable is optimized (k[2])





Na (degree of  lens distortion model polynom)= 		4
1 parameter, 2 iterations, variables updated: 		k[2], k[4]


	This means that, the algebraic method is applied as:
		first: 	one iteration (updating the k[2] variable only)
                second: one iteration updating k[2],k[4] (being the k[2] initialized at the previous solution)




Na (degree of  lens distortion model polynom) = 	4
2 parameters, 1 iteration, variables updated: 		k[2], k[4]


	This means that, 1 iteration od the algebraic method is applied for the two variables (k[2], k[4]) set free to evolve simultaneously.



REMARK 2�:
For the solution 5 and 6, the algebraic solution is exactly the same obtained for the cases solution 1 and 2, but, they were again calculated in order to  make the code clearer (avoiding saving previous solutions).
---------------------------------------------------------------------------------------------------------------- 


