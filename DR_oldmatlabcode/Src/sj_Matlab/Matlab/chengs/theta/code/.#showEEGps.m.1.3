function showEEGps(mtm, arg2, arg3)
%function showEEGps(mtm)
%function showEEGps(mtm, selectid)
%function showEEGps(mtm, rat, num)
%
% Analyze EEG power spectrum.

showPS= 1;
pausePlot= 1;
printPS= 0;

setLocalRoot;
if nargin== 3
    tet.rat= {arg2};
    tet.num= arg3;
    ntet= 1;
    %@@ this option does not work, yet
else
    if nargin==2
        selectid= arg2;
    else 
        selectid= 'all';
    end
    load(sprintf('%s/work/tetrodes-%s', root, selectid));
    tet= tetrodes;
    ntet= length(tet.rat);
%    load(sprintf('%s/work/epochs-%s', root, selectid));
%    ep= epochs;
%    nep= length(ep.rat);
end

ana.theta= zeros(1,ntet);
ana.max= zeros(1,ntet);
ana.width= zeros(1,ntet);
if(mtm)
    ana.stdmax= zeros(1,ntet);
end


for itet=1:ntet
    rat= tet.rat{itet};
    d= tet.num(itet,1); e= tet.num(itet,2); t= tet.num(itet,3);

    % change directory, set local options
    if itet==1 | ~strcmp(rat, tet.rat{itet-1}) | d~= tet.num(itet-1,1)
        if(mtm)
            psfile= sprintf('%s/%s/results/EEG/ps%.2d.mat',root,rat,d);
        else
            psfile= sprintf('%s/%s/results/pwelch/ps%.2d.mat',root,rat,d);
        end
        fprintf(1, 'loading %s ...\n', psfile);
        load(psfile);
    end

    if isempty(ps) | ...
        length(ps)<d | isempty(ps{d}) | ...
        length(ps{d})<e | isempty(ps{d}{e}) | ...
        length(ps{d}{e})<t | isempty(ps{d}{e}{t}) 
        error(sprintf('power spectral density was not caculated for tetrode %s [%d %d %d]',rat,d,e,t));
    end

    tstr= sprintf('%s [%d %d %d], itet= %d\n',rat,d,e,t,itet);
    f= ps{d}{e}{t}.freq;
    px= ps{d}{e}{t}.psd;
    ind= find(f>1 & f<30);

    if mtm
        pxm= mean(px,2);
        b=fir1(15,.005);
        pxs= filtfilt(b,1,pxm);
    else
        % filter power spectrum
        b=fir1(200,.01);
        pxs= filtfilt(b,1,px);
    end

    if showPS
        clf
        if mtm
            plot(f(ind), [pxs(ind) pxm(ind)]);
            title(tstr);
            if printPS
                print('-depsc2', sprintf('%s/work/pmtm-%s%.2d-%d-%.2d',root,rat,d,e,t));
            end
        else
            plot(f(ind), px(ind));
            hold on
            plot(f(ind), pxs(ind), 'g');
            title(tstr);
            if printPS
                print('-depsc2', sprintf('%s/work/pwelch-%s%.2d-%d-%.2d',root,rat,d,e,t));
            end
        end
        if pausePlot
            disp(tstr);
            pause
        end
    end
    
    % analyze power spectrum : peak height, width, peak location
    [ix, lx, hy, wx]= anaPeaks(pxs(ind),f(ind), .50, 'right');
%    keyboard

    ix= find(isfinite(wx));
    ix= ix(6<lx(ix) & lx(ix)<10);

%     deal with multiple peaks within theta band
    if length(ix)>1; 
        mhy= max(hy(ix));
        ix= ix(hy(ix)/mhy > .5);
        if length(ix)>1;
            warning('Cannot resolve multiple peaks within theta band. Manual intervention required.');
%            keyboard
        end
    end
    if isempty(ix); 
        disp(tstr);
        warning('could not find EEG peak within theta band'); 
        ana.theta(itet)= nan;
        ana.max(itet)= nan;
        ana.width(itet)= nan;
        if(mtm)
            ana.stdmax(itet)= nan;
        end
    else
        ana.theta(itet)= lx(ix);
        ana.max(itet)= hy(ix);
        ana.width(itet)= wx(ix);
        if(mtm)
            ana.stdmax(itet)= std(px(ix,:),0,2);
        end
    end

end

if(mtm)
    anafile= sprintf('%s/work/psana-pmtm-%s',root,selectid);
else
    anafile= sprintf('%s/work/psana-pwelch-%s',root,selectid);
end
save(anafile, 'ana');
