function runEEG(mtm, selectid)
%function runEEG(mtm)
%function runEEG(mtm, selectid)
%
% Calculate EEG power spectral density
%  mtm  whether to use multi-taper method

rerun= 1;
sepNovel= 1;  % compute theta power within theta band only

if nargin<1; mtm= 1; end
if nargin<2; selectid= 'all'; end

setLocalRoot;
load(sprintf('%s/work/tetrodes-%s', root, selectid));
tet= tetrodes;
ntet= length(tet.rat);
%load(sprintf('%s/work/epochs-%s', root, selectid);
%ep= epochs;
%nep= length(ep.rat);


fprintf(1, '\nAnalyzing EEG for %s...\n', selectid);
for itet=1:ntet
%for itet=56:ntet
    monitorProgress(itet, ntet);
    rat= tet.rat{itet};
    d= tet.num(itet,1); e= tet.num(itet,2); t= tet.num(itet,3);

    if itet==1 | ~strcmp(rat, tet.rat{itet-1}) | d~= tet.num(itet-1,1)
%    if itet==56 | ~strcmp(rat, tet.rat{itet-1}) | d~= tet.num(itet-1,1)
        bfile= sprintf('%s/%s/data2/behavdata%.2d.mat',root,rat,d);
        load(bfile);
        if(mtm)
            psfile= sprintf('%s/%s/results/EEG/ps%.2d.mat',root,rat,d);
        else
            psfile= sprintf('%s/%s/results/pwelch/ps%.2d.mat',root,rat,d);
        end
        if(exist(psfile,'file'))
            load(psfile);
        else
            ps= {};
        end
    end

    if ~rerun;
        if ~isempty(ps) & ...
            length(ps)>=d & ~isempty(ps{d}) & ...
            length(ps{d})>=e & ~isempty(ps{d}{e}) & ...
            length(ps{d}{e})>=t & ~isempty(ps{d}{e}{t}) 
                continue;
        end
    end

    fname= sprintf('%s/%s/data/EEG/%seeg%.2d-%d-%.2d.mat',root,rat,rat,d,e,t);
    load(fname);
    eval(sprintf('eegstruct= %seeg{%d}{%d}{%d};', rat, d, e, t));

    eeg= eegstruct.data;
    eeg= eeg/ sqrt(mean(eeg.^2));
    eegstruct.data= eeg;

    if(mtm)
        if sepNovel
            % only timesteps on valid traj
            if tet.day(itet)<7;  % novel exposure
                % convert between novel arm and traj
                if tet.newarm(itet) < 5;
                    trajs= [0, 1];
                elseif tet.newarm(itet) > 5;
                    trajs= [2, 3];
                end
            else  % familiar environment
                trajs= [0:3];
            end
            ind= find(ismember(behavdata{d}{e}.traj,trajs));

            % only on outer arm
            ind= ind(behavdata{d}{e}.linpos(ind)>75 & behavdata{d}{e}.linpos(ind)<150);
            nind= length(ind);
            dind= find(diff(ind)>1);
            hi= ind([dind; nind]);
            lo= ind([1;dind+1]);
            dt= behavdata{d}{e}.time(2)-behavdata{d}{e}.time(1);
            win= [behavdata{d}{e}.time(lo), behavdata{d}{e}.time(hi)+dt];

            [w, f, px] = swmts(eegstruct, win);
        else
            [w, f, px] = swmts(eegstruct);
        end
        pxs= mean(px,2);
        ps{d}{e}{t}.win= w;
        ps{d}{e}{t}.freq= f;
        ps{d}{e}{t}.psd= px;
    else
        fs= eegstruct.samprate;
        [px,f]=pwelch(eeg,[],[],[],fs);

        ps{d}{e}{t}.freq= f;
        ps{d}{e}{t}.psd= px;

        % smooth power spectrum
%        b=fir1(200,.01);
%        pxs= filtfilt(b,1,px);
    end
    
    save(psfile, 'ps');
end

