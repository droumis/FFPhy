function showRipples(pairs, rerun, varargin)

dtBurst= 0.010; % 10 ms
opt.nmin= 5;
minrips= 5;
alpha= 0.05;

global armId
id= 'pf9';
%armId= {'famArm', 'novelArm'};
armId= {'famArm', 'novelArm', 'cross'};
sets{1}.novelDay= 1;
sets{1}.label= 'day1';
sets{1}.arm= 'pf';  % {'famArm', 'novelArm', 'pf', 'nonpf'}
sets{2}.novelDay= 2;
sets{2}.label= 'day2';
sets{2}.arm= 'pf';
sets{3}.novelDay= 3;
sets{3}.label= 'day3';
sets{3}.arm= 'pf';

sets{4}.novelDay= 1;
sets{4}.label= 'day1';
sets{4}.arm= 'nonpf';
sets{5}.novelDay= 2;
sets{5}.label= 'day2';
sets{5}.arm= 'nonpf';
sets{6}.novelDay= 3;
sets{6}.label= 'day3';
sets{6}.arm= 'nonpf';

%id= 'CA1PE'; %@@
%sets{1}.novelDay= 1;
%sets{1}.label= 'day1';
%sets{1}.arm= 'cross';
%sets{2}.novelDay= 2;
%sets{2}.label= 'day2';
%sets{2}.arm= 'cross';
%sets{3}.novelDay= 3;
%sets{3}.label= 'day3';
%sets{3}.arm= 'cross';

na= length(armId);
for ia=1:na; sel{ia}.label= armId{ia}; end
b= {[-75:5:0], [0:5:75]};
x= [b{1}(1:end-1) b{2}(1:end-1)]+75;
dx= mean(diff(x));
x= x+dx/2;

TRAJ= {[0 1], [2 3]};

plotCoincNorm= 0;
plotCoincRate= 0;
plotCoincFrac= 0;
plotRipRate= 0;
plotOcc= 0;
plotSpikeRate= 0;
plotBurstRate= 0;
plotSpikes_Burst= 0;
plotNRips= 0;
plotNBursts= 0;
plotNSpikes= 0;
plotN12= 0;
plotDN12= 0;
plotZ= 0;
plotZd= 0;
plotNPairs= 0;
plotVel= 0;

% parsing argument list
if nargin<2; rerun= 0; end
v= varargin;
for i=1:length(v)
    switch v{i}
    case 'coincNorm'
        plotCoincNorm= 1;
    case 'coincFrac'
        plotCoincFrac= 1;
%        plotDN12= 1;
    case 'z'
        plotZ= 1;
    case 'zd'
        plotZd= 1;
    case 'nPairs'
        plotNPairs= 1;
    case 'ripRate'
        plotRipRate= 1;
    case 'spikeRate'
        plotSpikeRate= 1;
    case 'burstRate'
        plotBurstRate= 1;
    case 'spikes_burst'
        plotSpikes_Burst= 1;
    case 'nRips'
        plotNRips= 1;
    case 'nBursts'
        plotNBursts= 1;
    case 'nSpikes'
        plotNSpikes= 1;
    case 'vel'
        plotVel= 1;
    otherwise 
        error('unknown option');
    end
end

nb(1)= length(b{1})-1; nb(2)= length(b{2})-1;
setRoot
if pairs; pairStr= 'overlap_'; else pairStr= ''; na= 2; end

for is=1:length(sets)
    novelDay= sets{is}.novelDay;
    optstr{is}= sprintf('%s%s_%s_day%d', pairStr, sets{is}.arm, id, novelDay);
    fname{is}= sprintf('%s/work/xripples/data_%s.mat', root, optstr{is});

    clear ripRate count1 count2 count12 coincRate coincFrac
    clear nPairs iepoch
    clear coincNorm nRips nBursts nSpikes ripocc occ 

    if ~rerun & exist(fname{is}, 'file')== 2
        continue;
    end
    for ia=1:na
        if strfind(armId{ia}, 'cross') 
            [cl, nc]= mixPairs([id '-novelArm'], [id '-famArm']);
        else
            if strfind(id, 'pf') 
                selectid= [id '-' armId{ia}];
            else
                selectid= id;
            end
            [cl, nc]= collectCellList(selectid);
            if(pairs) [cl, nc]= collectPairs(cl, 'overlap', 0, 0); end
        end

        ie= 0; ix= 0;
        startic= 1;
        oldrat= ''; oldd= -1; olde= -1;
        for ic=startic:nc
            rat= cl.rat{ic};

            if(cl.day(ic)~= novelDay); continue; end
            d= cl.cellnum(ic,1); e= cl.cellnum(ic,2);
            t= cl.cellnum(ic,3); c= cl.cellnum(ic,4);

            if ~strcmp(rat, oldrat)
                load(sprintf('%s/%s/data2/info',root,rat));
            end
            if ~strcmp(rat, oldrat) | oldd~= d
                fprintf(1, '%s day %d\n', rat, d);
                load(sprintf('%s/%s/data2/spikedata%.2d.mat', root, rat, d));
                load(sprintf('%s/%s/data2/behavdata%.2d.mat', root, rat, d));
                load(sprintf('%s/%s/data/%slindistpos%.2d.mat',root,rat,rat,d));
                eval(['ldp= ' rat 'lindistpos;']);
                load(sprintf('%s/%s/data/%svel%.2d.mat',root,rat,rat,d));
                eval(['v= ' rat 'vel;']);
            end

            if ~strcmp(rat, oldrat) | oldd~= d | olde~= e
                oldrat= rat; oldd= d; olde= e;

                ie= ie+1;
                if strcmp(sets{is}.arm,'novelArm') | ...
                    (strcmp(sets{is}.arm,'pf') & ...
                        (strcmp(armId{ia}, 'novelArm') | strcmp(armId{ia}, 'cross'))) |...
                    (strcmp(sets{is}.arm,'nonpf') & strcmp(armId{ia}, 'famArm'))
                    % novel trajs
                    if cl.newarm(ic) < 5;
                        itraj=1; 
                    else
                        itraj=2;
                    end
                else 
                    % fam trajs
                    if cl.newarm(ic) < 5;
                        itraj=2;
                    else
                        itraj=1;
                    end
                end
                trajs= TRAJ{itraj};

                bd= behavdata{d}{e};
                center= info{d}{e}.centerlinpos;
                x= bd.linpos-center;
                dt= mean(diff(bd.time));
                trajvalid= ismember(ldp{d}{e}.estinfo, trajs);

                velocity= interp1(v{d}{e}.data(:,1), v{d}{e}.data(:,2), ldp{d}{e}.data(:,1));

%                ind= find(bd.ripple & trajvalid);
                ind= find(bd.ripple & trajvalid & bd.traj<0); %@@
                [lo hi]= findcontiguous(ind);
                nrip= length(lo);
                xrip= x(lo);

                for j=1:2
                    occtmp= saveHistc(x(trajvalid), b{j});
                    ripocctmp{j}= saveHistc(x(ind), b{j});

                    tmp= saveHistc(xrip, b{j});
                    nRips{ia}{j}(ie,:)= tmp(1:end-1);

                    occ{ia}{j}(ie,:)= occtmp(1:end-1)*dt;
                    occtmp(occtmp==0)= nan;
                    tmp= ripocctmp{j}(1:end-1)./occtmp(1:end-1);
%                        tmp(~isfinite(tmp))= 0;
                    ripocc{ia}{j}(ie,:)= tmp;

                    tmp= nRips{ia}{j}(ie,:)./occtmp(1:end-1);
%                        tmp(~isfinite(tmp))= 0;
                    ripRate{ia}{j}(ie,:)= tmp/dt;

                    if pairs; nPairs{ia}{j}(ie,:)= zeros(1,nb(j)); end

                    armind= ind(b{j}(1)<= x(ind) & x(ind) <= b{j}(end));
                    vel{ia}{j}(ie)= mean(velocity(armind));
                end
            end

            ix= ix+1;
            sd= spikedata{d}{e}{t}{c};
            spind= find(trajvalid(sd.index) & bd.ripple(sd.index));
            ind= sd.index(spind);
            if pairs
                sd2= spikedata{d}{e}{cl.cellnum(ic,7)}{cl.cellnum(ic,8)};
                ind2= sd2.index(trajvalid(sd2.index) & bd.ripple(sd2.index));
            end
            for j=1:2
                iepoch{ia}{j}(ix)= ie;
                sptmp= saveHistc(x(ind), b{j});
                nSpikes{ia}{j}(ix,:)= sptmp(1:end-1);

                tmp= find(diff(sd.time(spind))<dtBurst);
                indBurst= spind;
                indBurst(tmp+1)= nan;
                indBurst= indBurst(isfinite(indBurst));
                tmp= saveHistc(x(sd.index(indBurst)), b{j});
                nBursts{ia}{j}(ix,:)= tmp(1:end-1);

                if pairs
                    nPairs{ia}{j}(ie,:)= nPairs{ia}{j}(ie,:) + 1;
                    sptmp= saveHistc(x(ind2), b{j});
                    spcount2{ia}{j}(ix,:)= sptmp(1:end-1);
                    found= false(1, nrip); found2= false(1, nrip);
                    for ir=1:nrip
                         if find(lo(ir)<= ind & ind <=hi(ir)) found(ir)=true; end
                         if find(lo(ir)<= ind2 & ind2 <=hi(ir)) found2(ir)=true; end
                    end
                    tmp= saveHistc(xrip(found), b{j});
                    count1{ia}{j}(ix,:)= tmp(1:end-1);
                    tmp= saveHistc(xrip(found2), b{j});
                    count2{ia}{j}(ix,:)= tmp(1:end-1);
                    tmp= saveHistc(xrip(found & found2), b{j});
                    count12{ia}{j}(ix,:)= tmp(1:end-1);



                    tmp= occ{ia}{j}(ie,:);
                    tmp(tmp==0)= nan;
                    tmp=  count12{ia}{j}(ix,:)./tmp;
%                        tmp(~isfinite(tmp))= 0;
                    coincRate{ia}{j}(ix,:)= tmp;

                    tmp= nRips{ia}{j}(ie,:);
                    tmp(tmp<5)= nan;
                    tmp=  count12{ia}{j}(ix,:)./tmp;
                    tmp(~isfinite(tmp))= 0;
                    coincFrac{ia}{j}(ix,:)= tmp;
%                        coincFrac{ia}{j}(ix,:)= count12{ia}{j}(ix,:)/ sum(nRips{ia}{j}(ie,:));

                    tmp= ripRate{ia}{j}(ie,:);
                    tmp(tmp==0)= nan;
                    tmp=  count12{ia}{j}(ix,:)./tmp;
%                        tmp(~isfinite(tmp))= 0;
                    coincNorm{ia}{j}(ix,:)= tmp;
                end
            end

%            if(ie>=2); break; end %%@@
        end
    end
    if pairs
        save(fname{is}, 'nPairs', ...
        'count1', 'count2', 'count12', 'coincRate', 'coincFrac', 'coincNorm', ...
            'nRips', 'nBursts', 'nSpikes', 'ripocc', 'occ', ...
            'vel', 'iepoch', 'armId', 'b');
    else
        save(fname{is}, 'nRips', 'nBursts', 'nSpikes', 'ripocc', 'occ', ...
            'vel', 'iepoch', 'armId', 'b');
    end
end % for is; do analysis

for is=1:length(sets)
    load(fname{is});

    plotcol= {[[0 0 0]; [1 0 0]], [[0 0 0]; [0 1 0]], [[0 0 0]; [0 0 1]]};
    opt.plotcol= plotcol{sets{is}.novelDay};

    opt.outname= optstr{is}; 
%    opt.xrange= [0 150];

    if plotCoincRate
        opt.label= 'coincidence rate'; opt.title= 'ripCoincRate';
        opt.yrange= [-0.01 0.2];
        auxImage(b, coincRate, opt)
    end
    if plotCoincFrac
        opt.label= 'coincidence frac'; opt.title= 'ripCoincFrac';
        opt.yrange= [-0.005 0.36]; 
%        auxImage(b, coincFrac, opt)
        for ia=1:na
            f= [];
            for j=2
%                num= sum(count12{ia}{j});
%                den= sum(nPairs{ia}{j}.*nRips{ia}{j});
                num= sum(count12{ia}{j},2);
                den= sum(nRips{ia}{j}(iepoch{ia}{j},:),2);
                ind= find(den>=minrips);
                den(den<minrips)= nan;
                frac{ia}{j}= num./den;
                N{ia}{j}= den;
%                ci{ia}{j}= norminv(1-alpha/2)*sqrt(frac{ia}{j}.*(1-frac{ia}{j})./den);
                ci{ia}{j}= sqrt(frac{ia}{j}.*(1-frac{ia}{j})./den);
                f= [f; frac{ia}{j}(ind)];
            end
            COINCFRAC{is}{ia}= f;
        end
%        auxImage(b, frac, opt, ci)
%        auxAnova1(COINCFRAC{is}, sets{is}, opt);
%        opt.plotcol(3,:)= 0.7*[1 1 1];
%        auxCmpDist2(COINCFRAC{is}, sel, opt);
    end
    if plotCoincNorm
        opt.label= 'coincNorm'; opt.title= 'ripCoincNorm';
        opt.yrange= [-1 33];
        auxImage(b, coincNorm, opt)
    end
%        opt.label= 'count1'; opt.title= 'ripCount1';
%        auxImage(b, count1, opt)
%        opt.label= 'count2'; opt.title= 'ripCount2';
%        auxImage(b, count2, opt)
%        opt.label= 'count12'; opt.title= 'ripCount12';
%        opt.yrange= [-0.1 9];
%        auxImage(b, count12, opt)

    if plotZ | plotZd
        Z= cell(1,na);
        for ia=1:na
            for j=1:2
                N= nRips{ia}{j}(iepoch{ia}{j},:);
                n12= count12{ia}{j};
                n1= count1{ia}{j};
                n2= count2{ia}{j};

                z{ia}{j}= nan*ones(size(N));
                N(N<5)= nan; 
%                n1(n1<2)= nan; n2(n2<2)= nan;
%                dn12{ia}{j}= n12-n1.*n2./N;
                V= n1.*n2.*(N-n1).*(N-n2)./ (N.^2.*(N-1));
%                        z{ia}{j}(ix,V==0)= 0;
                zind= find(V>0);
                z{ia}{j}(zind)= (n12(zind)-n1(zind).*n2(zind)./N(zind))./sqrt(V(zind));

                ztmp= z{ia}{j};
%                ztmp= z{ia}{j}(:,[1,2,14,15]);
                Z{ia}= [Z{ia}; ztmp(isfinite(ztmp))];
            end
            Zd{is}{ia}= Z{ia};
        end
        opt.label= 'z'; opt.title= 'z';
        sel{1}.label= 'fam'; sel{2}.label= 'novel';
        if plotZ auxCmpDist2(Zd{is}, sel, opt); end
%        opt.yrange= [0 1];
%        auxImage(b, z, opt)
%        auxDist(b, z, sets, opt)
%        auxAnova1(Zd{is}, sets{is}, opt);
        opt.plotcol(3,:)= 0.7*[1 1 1];
        auxCmpDist2(Zd{is}, sel, opt);
    end
        
    if plotDN12
        opt.label= 'n12-E[n12]'; opt.title= 'dn12';
%        opt.yrange= [0 1];
        auxImage(b, dn12, opt)
    end
        
    if plotNPairs
        opt.label= 'n pairs'; opt.title= 'nPairs';
        auxImage(b, nPairs, opt)
    end
        
    if plotRipRate
%        opt.label= 'ripple rate (Hz)'; opt.title= 'ripRate'; 
%        opt.yrange= [-0.05 0.9];
%        auxImage(b, ripRate, opt)
        for ia=1:na
            r= [];
            for j=2
                N= sum(nRips{ia}{j}, 2);
                O= sum(occ{ia}{j}, 2);
                ind= O>= 1;
                r= [r; N(ind)./ O(ind)];
            end
            RIPRATE{is}{ia}= r;
        end
    end

    if plotSpikeRate
        opt.label= 'spikes/ripple'; opt.title= 'ripSpikeRate';
%        opt.yrange= [-0.5 35];
        for ia=1:na
            sp= [];
            for j=2
                N= sum(nRips{ia}{j}(iepoch{ia}{j},:), 2);
                n= sum(nSpikes{ia}{j}, 2);
                spikerate{ia}{j}= nan*ones(size(N));
                ind= N>= opt.nmin;
                spikerate{ia}{j}(ind)= n(ind)./ N(ind);
                sp= [sp; n(ind)./ N(ind)];
            end
            SPRATE{is}{ia}= sp;
        end
%        auxImage(b, spikerate, opt)
        auxAnova1(SPRATE{is}, sets{is}, opt);
    end
    if plotBurstRate
        opt.label= 'burst/ripple'; opt.title= 'ripBurstRate';
%        opt.yrange= [-0.25 25];
        burstrate= {};
        for ia=1:na
            for j=1:2
                N= nRips{ia}{j}(iepoch{ia}{j},:);
                n= nBursts{ia}{j};
                burstrate{ia}{j}= nan*ones(size(N));
                ind= N>= opt.nmin;
                burstrate{ia}{j}(ind)= n(ind)./ N(ind);
            end
        end
        auxImage(b, burstrate, opt)
    end
    if plotSpikes_Burst
        opt.label= 'spikes/burst'; opt.title= 'ripSpikes_Burst';
        opt.yrange= [0.98 3];
        sp_burst= {};
        for ia=1:na
            for j=1:2
                n= nSpikes{ia}{j};
                N= nBursts{ia}{j};
                sp_burst{ia}{j}= nan*ones(size(N));
                ind= N>= opt.nmin;
                sp_burst{ia}{j}(ind)= n(ind)./ N(ind);
            end
        end
        auxImage(b, sp_burst, opt)
    end
%        opt.label= 'ripple frac'; opt.title= 'ripFraction';
%        auxImage(b, ripocc, opt)
%        opt.label= 'ripple count'; opt.title= 'nRips'; 
%        opt.yrange= [-1 35];
%        auxImage(b, nRips, opt)

    if plotOcc
        opt.label= 'occupancy (s)'; opt.title= 'occ';
        opt.yrange= [0 130];
        auxImage(b, occ, opt)
    end
    if plotN12
        opt.label= 'coinc. count'; opt.title= 'n12';
%        opt.yrange= [0 130];
        auxImage(b, count12, opt)
    end
    if plotVel
        for ia=1:na
            v= [];
            for j=2
                v= [v, vel{ia}{j}];
            end
            VEL{is}{ia}= v;
        end
    end
end % for is; show analysis


range={[1:3], [4:6]};
for i=1:2
    opt.outname= sprintf('%s%s_%s', pairStr, sets{(i-1)*3+1}.arm, id);
    if plotZd
        opt.ylabel= 'z-score'; opt.title= 'z'; 
        opt.plotsize=[1.5 2/3];
    %    opt.ylim= [-0.1 1.9];
        auxPlotBars(Zd(range{i}), opt);
%        auxAnova(Zd(range{i}), sets(range{i}), opt);
    end
    if plotCoincFrac
        opt.ylabel= 'coincidence frac'; opt.title= 'ripCoincFrac';
        opt.ylim= [0 0.3];
        auxPlotBars(COINCFRAC(range{i}), opt);
%        auxAnova(COINCFRAC(range{i}), sets(range{i}), opt);
    end
    if plotRipRate
        opt.ylabel= 'ripple rate (Hz)'; opt.title= 'ripRate'; 
    %    opt.yrange= [-0.05 0.9];
        auxPlotBars(RIPRATE(range{i}), opt);
%        auxAnova(RIPRATE(range{i}), sets(range{i}), opt);
    end
    if plotSpikeRate
        opt.ylabel= 'spikes/ripple'; opt.title= 'ripSpikeRate'; 
        opt.plotsize=[1.5 2/3]; 
        opt.ylim= [0 1.3];
        auxPlotBars(SPRATE(range{i}), opt);
%        auxAnova(SPRATE(range{i}), sets(range{i}), opt);
    end
    if plotVel
        opt.ylabel= 'velocity (cm/s)'; opt.title= 'ripVel'; 
        opt.plotsize=[1.5 2/3]; 
    %    keyboard
        auxPlotBars(VEL(range{i}), opt);
    end
end

if plotZd
    opt.ylabel= 'z-score'; opt.title= 'z'; 
%    auxAnova(Zd, sets, opt);
end

if plotCoincFrac
    opt.ylabel= 'coincidence frac'; opt.title= 'ripCoincFrac';
%    auxAnova(COINCFRAC, sets, opt);
end

if plotSpikeRate
    opt.ylabel= 'spikes/ripple'; opt.title= 'ripSpikeRate'; 
%    auxAnova(SPRATE, sets, opt);
end

if plotRipRate
    opt.ylabel= 'ripple rate (Hz)'; opt.title= 'ripRate'; 
%    auxAnova(RIPRATE, sets, opt);
end

function auxImage(b, z, opt, dev)

% calc mean
for ia=1:length(z)
    for j=1:length(z{ia})
        zm{ia}{j}= mean(z{ia}{j});
    end
end

if isfield(opt, 'yrange')
    minz= opt.yrange(1); maxz= opt.yrange(2);
else
    % find max value
    minz= 0; maxz= nan; 
    for ia=1:length(z)
        for j=1:length(z{ia})
            maxz= max(maxz, max(max(zm{ia}{j})));
        end
    end
end

for j=1:2
    ib{j}= 1:length(b{j});
end

thick= 2;

if(0)
figure
hold on
%novel home arm
imagesc(1:thick, -fliplr(ib{1}), zm{1}{1}'*ones(1,thick), [minz maxz])
%novel arm
imagesc(ib{2}+thick, 0:thick-1, ones(thick,1)*zm{1}{2}, [minz maxz])

%fam home arm
imagesc(-[1:thick], -fliplr(ib{1}), zm{2}{1}'*ones(1,thick), [minz maxz])
%fam arm
imagesc(-ib{2}-thick, 0:thick-1, ones(thick,1)*zm{2}{2}, [minz maxz])
axis off auto equal 
%colorbar
figname= ['geo_' opt.title '_' opt.outname];
set(gcf, 'Name', figname);
myprint(2*[1 2/3], figname);
end


x= [b{1}(1:end-1) b{2}(1:end-1)]+75;
dx= mean(diff(x));
x= x+dx/2;
%      fam arm           novel arm
y= {[z{1}{1} z{1}{2}], [z{2}{1} z{2}{2}]};
%novel arm
%plot([b{1}(1:end-1) b{2}(1:end-1)], [zm{1}{1} zm{1}{2}], 'r')
%fam arm
%plot([b{1}(1:end-1) b{2}(1:end-1)], [zm{2}{1} zm{2}{2}], 'k')

if(1)
figure
hold on
if nargin>= 3;
    d= {[dev{1}{1} dev{1}{2}], [dev{2}{1} dev{2}{2}]};
    h= auxPlotMeanDev(x,y,opt,d);
else
    h= auxPlotMeanDev(x,y,opt);
end
hold on
plot([75 75], get(gca, 'YLim'), 'k--');
%set(gca, 'xlim', [-75, 75]);
%legend({'novel', 'fam'}, 0)
xlabel('position (cm)');
ylabel(opt.label);
figname= ['lin_' opt.title '_' opt.outname];
set(gcf, 'Name', figname);
myprint([1.5 1], figname);
end

if(0)
opt.ylabel= opt.label;
opt.plotsize=[1.5 2/3];
    opt.outname= ['lin_' opt.title '_' opt.outname];
    for i=1:2; 
        my(:,i)= nanmean(y{i})'; 
        n= sum(isfinite(y{i}));
        n(n<1)= nan;
        dy(:,i)= nanstd(y{i})'./sqrt(n)'; 
        my(~isfinite(dy(:,i)),i)= nan;
    end
    auxBar(my, dy, opt);
end

function h= saveHistc(x, b)
if isempty(x);
    h= zeros(1, length(b));
else
    h= histc(x, b);
end
if size(h,1)>1 & size(h,2)==1; h= h'; end

function auxDist(b, z, sets, opt)
x= [b{1}(1:end-1) b{2}(1:end-1)]+75;
dx= mean(diff(x));
x= x+dx/2;
%      fam arm           novel arm
y= {[z{1}{1} z{1}{2}], [z{2}{1} z{2}{2}]};
%figure
%subplot(2,1,1)
%plot(x,y{1}')
%title('fam')
%subplot(2,1,2)
%plot(x,y{2}')
%title('novel')
%myprint([1.5 1], figname);
%xlabel('position (cm)');
%ylabel('z score');
%orient tall
%print('-dpsc', figname);

hold on
for i=1:length(x)
    for j=1:2
        t= y{j}(:,i);
        t= t(isfinite(t));
        if length(t)>2 & sum(t) > 0
            [h, p]= ttest(t,0.5);
            if(p<0.01) 
                hs= plot(x(i)+[-1 1], mean(t)+.2*[1 1], '*'); 
                set(hs, 'Color', opt.plotcol(j,:));
            elseif(p<0.05) 
                hs= plot(x(i), mean(t)+.1, '*'); 
                set(hs, 'Color', opt.plotcol(j,:));
            end
        end
    end
end


%figname= ['lin-' opt.title '-' opt.outname];
%set(gcf, 'Name', figname);
%myprint('large', figname, [], 0);

function y= auxCollate(z)
%      fam arm           novel arm
y= {[z{1}{1} z{1}{2}], [z{2}{1} z{2}{2}]};

function auxPlotBars(Zd, opt)
for d=1:3
    for ia=1:length(Zd{d})
        Zm(d,ia)= nanmean(Zd{d}{ia});
        Zdev(d,ia)= nanstd(Zd{d}{ia})/sqrt(sum(isfinite(Zd{d}{ia})));
        if ia>1
%             [h,p(d,ia-1)]= ttest2(Zd{d}{ia-1}, Zd{d}{ia});
             [p(d,ia-1), h]= ranksum(Zd{d}{ia-1}, Zd{d}{ia});
%             [h,p(d,ia-1)]= kstest2(Zd{d}{ia-1}, Zd{d}{ia});
         end
    end
%    p(d,:)= p(d,:)* length(p(d,:));
end
opt.xticklabels= {'day1'  'day2'  'day3'}; 
opt.plotcol={zeros(3,3), [[1 0 0]; [0 1 0]; [0 0 1]], [.7*ones(3,3)]};
auxBar(Zm, Zdev, opt, p);

function auxAnova1(Z, set, opt)
return
figure
n= 0; g=[]; y=[];
for ia=1:length(Z)
    len= length(Z{ia});
    y(n+1:n+len)= Z{ia};
    g(n+1:n+len)= ia;
    n=n+len;
end
%[p, tab, stats]= anova1(y, g, 'off');
[p, tab, stats]= kruskalwallis(y, g, 'off');
%mc= multcompare(stats, 'alpha', 0.01);
mc= multcompare(stats, 'alpha', 0.01, 'ctype', 'bonferroni'); tab
%set(gcf, 'Name', [opt.label '-' set.arm])
%mc
%keyboard

function auxAnova(Z, sets, opt)

figure
ns= length(sets);
for is=1:ns
    switch sets{is}.arm
    case 'famArm';
        sets{is}.arm= 1;
    case 'novelArm';
        sets{is}.arm= 2;
    case 'cross';
        sets{is}.arm= 3;
    end
end
global armId
if ns>3
    names= strvcat('pf-loc', 'day', 'arm');
else
    names= strvcat('pf-loc', 'day');
end
n= 0; g={}; y=[];
for is=1:length(Z)
    for ia=1:length(Z{is})
%        if(sets{is}.arm==1) continue; end
        len= length(Z{is}{ia});
        y(n+1:n+len)= Z{is}{ia};
        g{1}(n+1:n+len)= ia;
        g{2}(n+1:n+len)= sets{is}.novelDay;
        if ns>3;  g{3}(n+1:n+len)= sets{is}.arm; end
        n=n+len;
    end
end

[p, tab, stats]= anovan(y, g, 'full', 3, names, 'off');
%mc= multcompare(stats, 'alpha', 0.01, 'ctype', 'bonferroni', 'dimension', [1:length(g)]);
mc= multcompare(stats, 'alpha', 0.05, 'dimension', [1:length(g)]);
tab
%mc
%keyboard
